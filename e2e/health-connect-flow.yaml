# Health Connect Integration E2E Tests
# Run with: maestro test e2e/health-connect-flow.yaml
# Note: These tests require an Android device with Health Connect installed

appId: com.nutritionrx.app
---

# Test: Navigate to Health Connect settings
- launchApp
- waitForAnimationToEnd

# Navigate to Settings tab
- tapOn:
    text: "Settings"

- waitForAnimationToEnd

# Scroll to find Health Connect option
- scrollUntilVisible:
    element:
      text: "Health Connect"
    direction: DOWN

- tapOn:
    text: "Health Connect"

- waitForAnimationToEnd

# Verify Health Connect screen is shown
- assertVisible:
    text: "Health Connect"

---

# Test: Health Connect onboarding flow (when not connected)
- launchApp:
    clearState: true
- waitForAnimationToEnd

- tapOn:
    text: "Settings"

- scrollUntilVisible:
    element:
      text: "Health Connect"
    direction: DOWN

- tapOn:
    text: "Health Connect"

# Verify onboarding UI is shown
- assertVisible:
    text: "Keep your health data connected"

- assertVisible:
    text: "Connect Now"

# Verify bullet points are shown
- assertVisible:
    text: "Sync your nutrition automatically"

- assertVisible:
    text: "See weight from your smart scale"

- assertVisible:
    text: "Adjust goals based on activity"

---

# Test: Connect button triggers permission flow
- launchApp:
    clearState: true
- waitForAnimationToEnd

- tapOn:
    text: "Settings"

- scrollUntilVisible:
    element:
      text: "Health Connect"
    direction: DOWN

- tapOn:
    text: "Health Connect"

# Tap Connect Now button
- tapOn:
    text: "Connect Now"

# Wait for permission dialog
- waitForAnimationToEnd:
    timeout: 5000

# Note: The actual permission dialog is system UI
# Testing continues after manual permission grant

---

# Test: Settings toggles (when connected)
# Note: This test assumes Health Connect is already connected

- launchApp
- waitForAnimationToEnd

- tapOn:
    text: "Settings"

- scrollUntilVisible:
    element:
      text: "Health Connect"
    direction: DOWN

- tapOn:
    text: "Health Connect"

- waitForAnimationToEnd

# Check if connected (look for toggle labels)
- assertVisible:
    text: "Sync nutrition"
    optional: true

# If connected, verify all toggle options are present
- runFlow:
    when:
      visible: "Sync nutrition"
    commands:
      - assertVisible:
          text: "Sync water intake"
      - assertVisible:
          text: "Read weight"
      - assertVisible:
          text: "Adjust for activity"
      - assertVisible:
          text: "How this works"

---

# Test: Activity calories explainer modal
- launchApp
- waitForAnimationToEnd

- tapOn:
    text: "Settings"

- scrollUntilVisible:
    element:
      text: "Health Connect"
    direction: DOWN

- tapOn:
    text: "Health Connect"

# Wait for screen to load
- waitForAnimationToEnd

# Only run if connected
- runFlow:
    when:
      visible: "How this works"
    commands:
      - tapOn:
          text: "How this works"
      - waitForAnimationToEnd
      - assertVisible:
          text: "Exercise calories explained"
      - assertVisible:
          text: "Your goal: 2,000 calories"
      - assertVisible:
          text: "A gentle note"
      - tapOn:
          text: "Got it"
      - waitForAnimationToEnd

---

# Test: Open Health Connect settings link
- launchApp
- waitForAnimationToEnd

- tapOn:
    text: "Settings"

- scrollUntilVisible:
    element:
      text: "Health Connect"
    direction: DOWN

- tapOn:
    text: "Health Connect"

# Wait for screen to load
- waitForAnimationToEnd

# Only run if connected
- runFlow:
    when:
      visible: "Manage in Health Connect"
    commands:
      - tapOn:
          text: "Manage in Health Connect"
      # Note: This opens Health Connect app, testing stops here

---

# Test: Error state display
# Note: This test requires simulating an error condition

- launchApp
- waitForAnimationToEnd

- tapOn:
    text: "Settings"

- scrollUntilVisible:
    element:
      text: "Health Connect"
    direction: DOWN

- tapOn:
    text: "Health Connect"

# If error banner is shown, verify it can be dismissed
- runFlow:
    when:
      visible: "Couldn't sync"
    commands:
      # Tap the close button on error banner
      - tapOn:
          id: "error-dismiss"
          optional: true

---

# Test: Privacy notice is shown
- launchApp
- waitForAnimationToEnd

- tapOn:
    text: "Settings"

- scrollUntilVisible:
    element:
      text: "Health Connect"
    direction: DOWN

- tapOn:
    text: "Health Connect"

# Scroll to bottom to see privacy notice
- scrollUntilVisible:
    element:
      text: "Your data is stored securely"
    direction: DOWN
    timeout: 5000

- assertVisible:
    text: "Your data is stored securely"

---

# Test: Help section is shown
- launchApp
- waitForAnimationToEnd

- tapOn:
    text: "Settings"

- scrollUntilVisible:
    element:
      text: "Health Connect"
    direction: DOWN

- tapOn:
    text: "Health Connect"

# Scroll to bottom to see help section
- scrollUntilVisible:
    element:
      text: "Need help?"
    direction: DOWN
    timeout: 5000

- assertVisible:
    text: "Need help?"

- assertVisible:
    text: "you can re-enable access in"

---

# Test: Back navigation
- launchApp
- waitForAnimationToEnd

- tapOn:
    text: "Settings"

- scrollUntilVisible:
    element:
      text: "Health Connect"
    direction: DOWN

- tapOn:
    text: "Health Connect"

- waitForAnimationToEnd

# Tap back button
- tapOn:
    point: "5%,5%"  # Top-left back button area

- waitForAnimationToEnd

# Verify we're back at Settings
- assertVisible:
    text: "Settings"
